{% extends "base.html" %}

{% block content %}
<div class="card">
    <h2><i class="fas fa-upload"></i> Upload e Conversão de Vídeo</h2>
    
    {% if not ffmpeg_available %}
    <div class="alert alert-danger">
        <i class="fas fa-exclamation-triangle"></i>
        <strong>FFmpeg não encontrado!</strong> 
        Para usar esta aplicação, você precisa instalar o FFmpeg primeiro.
        <br><br>
        <strong>Instruções de instalação:</strong><br>
        <code>sudo apt update && sudo apt install -y ffmpeg</code>
    </div>
    {% endif %}

    <form id="uploadForm" enctype="multipart/form-data">
        <div class="form-group">
            <label for="fileInput">Selecione o arquivo de vídeo:</label>
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" name="file" class="file-input" accept="video/*" required>
                <label for="fileInput" class="file-input-label" id="fileInputLabel">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #667eea; margin-bottom: 10px;"></i>
                    <br>
                    <strong>Clique aqui ou arraste um arquivo de vídeo</strong>
                    <br>
                    <small>Formatos suportados: MP4, MKV, AVI, MOV, etc.</small>
                </label>
            </div>
        </div>

        <div class="form-group">
            <label>Escolha a operação:</label>
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="operation" value="convert" checked style="margin-right: 8px;">
                    <i class="fas fa-exchange-alt" style="margin-right: 5px; color: #667eea;"></i>
                    Converter MKV → MP4
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="operation" value="compress" style="margin-right: 8px;">
                    <i class="fas fa-compress" style="margin-right: 5px; color: #28a745;"></i>
                    Comprimir MP4
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="operation" value="extract_mp3" style="margin-right: 8px;">
                    <i class="fas fa-music" style="margin-right: 5px; color: #e83e8c;"></i>
                    Extrair MP3
                </label>
            </div>
        </div>

        <div class="form-group">
            <button type="submit" class="btn" id="submitBtn" {% if not ffmpeg_available %}disabled{% endif %}>
                <i class="fas fa-play"></i> Iniciar Processamento
            </button>
            <button type="button" class="btn btn-secondary" id="clearBtn">
                <i class="fas fa-trash"></i> Limpar
            </button>
        </div>
    </form>

    <div id="statusContainer" class="hidden">
        <div class="alert alert-info">
            <div id="statusMessage">
                <span class="spinner"></span>
                Preparando processamento...
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
    </div>

    <div id="resultContainer" class="hidden">
        <div class="alert alert-success">
            <i class="fas fa-check-circle"></i>
            <strong>Processamento concluído!</strong>
            <div id="resultMessage"></div>
            <div style="margin-top: 15px;">
                <a href="/results" class="btn btn-success">
                    <i class="fas fa-folder-open"></i> Ver Resultados
                </a>
            </div>
        </div>
    </div>

    <div id="errorContainer" class="hidden">
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i>
            <strong>Erro no processamento!</strong>
            <div id="errorMessage"></div>
        </div>
    </div>
</div>

<div class="card">
    <h3><i class="fas fa-info-circle"></i> Informações sobre as Operações</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
        <div>
            <h4><i class="fas fa-exchange-alt" style="color: #667eea;"></i> Converter MKV → MP4</h4>
            <p>Converte arquivos MKV para o formato MP4, mantendo a qualidade do vídeo e convertendo o áudio para AAC para melhor compatibilidade.</p>
        </div>
        <div>
            <h4><i class="fas fa-compress" style="color: #28a745;"></i> Comprimir MP4</h4>
            <p>Reduz o tamanho do arquivo MP4 usando compressão H.264, mantendo boa qualidade visual. Ideal para economizar espaço.</p>
        </div>
        <div>
            <h4><i class="fas fa-music" style="color: #e83e8c;"></i> Extrair MP3</h4>
            <p>Extrai apenas o áudio do arquivo de vídeo e salva como MP3 com qualidade máxima. Perfeito para criar arquivos de áudio.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    const fileInput = $('#fileInput');
    const fileInputLabel = $('#fileInputLabel');
    const uploadForm = $('#uploadForm');
    const statusContainer = $('#statusContainer');
    const resultContainer = $('#resultContainer');
    const errorContainer = $('#errorContainer');
    const submitBtn = $('#submitBtn');
    const clearBtn = $('#clearBtn');

    // File input change handler
    fileInput.on('change', function() {
        const file = this.files[0];
        if (file) {
            fileInputLabel.html(`
                <i class="fas fa-file-video" style="font-size: 2rem; color: #28a745; margin-bottom: 10px;"></i>
                <br>
                <strong>${file.name}</strong>
                <br>
                <small>${(file.size / (1024 * 1024)).toFixed(2)} MB</small>
            `);
        }
    });

    // Drag and drop handlers
    fileInputLabel.on('dragover', function(e) {
        e.preventDefault();
        $(this).addClass('dragover');
    });

    fileInputLabel.on('dragleave', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
    });

    fileInputLabel.on('drop', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
        const files = e.originalEvent.dataTransfer.files;
        if (files.length > 0) {
            fileInput[0].files = files;
            fileInput.trigger('change');
        }
    });

    // Clear button
    clearBtn.on('click', function() {
        fileInput.val('');
        fileInputLabel.html(`
            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #667eea; margin-bottom: 10px;"></i>
            <br>
            <strong>Clique aqui ou arraste um arquivo de vídeo</strong>
            <br>
            <small>Formatos suportados: MP4, MKV, AVI, MOV, etc.</small>
        `);
        hideAllContainers();
    });

    // Form submission
    uploadForm.on('submit', function(e) {
        e.preventDefault();
        
        if (!fileInput[0].files[0]) {
            alert('Por favor, selecione um arquivo de vídeo.');
            return;
        }

        const formData = new FormData(this);
        submitBtn.prop('disabled', true);
        hideAllContainers();
        statusContainer.removeClass('hidden');

        $.ajax({
            url: '/upload',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.task_id) {
                    pollStatus(response.task_id);
                } else {
                    showError('Erro ao iniciar processamento.');
                }
            },
            error: function(xhr) {
                const error = xhr.responseJSON ? xhr.responseJSON.error : 'Erro de comunicação.';
                showError(error);
            }
        });
    });

    function pollStatus(taskId) {
        $.get('/status/' + taskId)
            .done(function(data) {
                updateStatus(data);
                
                if (data.status === 'processing') {
                    setTimeout(() => pollStatus(taskId), 1000);
                } else if (data.status === 'completed') {
                    showResult(data.message, data.output_file);
                } else if (data.status === 'error') {
                    showError(data.message);
                }
            })
            .fail(function() {
                showError('Erro ao verificar status do processamento.');
            });
    }

    function updateStatus(data) {
        $('#statusMessage').html(`
            <span class="spinner"></span>
            ${data.message}
        `);
    }

    function showResult(message, outputFile) {
        hideAllContainers();
        resultContainer.removeClass('hidden');
        $('#resultMessage').html(message);
        submitBtn.prop('disabled', false);
    }

    function showError(message) {
        hideAllContainers();
        errorContainer.removeClass('hidden');
        $('#errorMessage').html(message);
        submitBtn.prop('disabled', false);
    }

    function hideAllContainers() {
        statusContainer.addClass('hidden');
        resultContainer.addClass('hidden');
        errorContainer.addClass('hidden');
    }
});
</script>
{% endblock %}